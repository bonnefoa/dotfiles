#compdef z

function _z() {
    # Only show completions when the cursor is at the end of the line.
    # shellcheck disable=SC2154
    [[ "${#words[@]}" -eq "${CURRENT}" ]] || return
    local result
    # shellcheck disable=SC2086,SC2312
    if result="$(\command zoxide query --exclude "$(__zoxide_pwd)" -i -- ${words[2,-1]})"; then
        __zoxide_result="${result}"
    else
        __zoxide_result=''
    fi

    # Set a result to ensure completion doesn't re-run
    compadd -Q ""

    # Bind '\e[0n' to helper function.
    \builtin bindkey '\e[0n' '__zoxide_z_complete_helper'
    # Sends query device status code, which results in a '\e[0n' being sent to console input.
    \builtin printf '\e[5n'

    return 0
}
